alias: evap_apply_mode_and_fan_with_twb
mode: queued
fields:
  evap_entity:
    description: Climate entity
    example: climate.evap
  hvac_mode:
    description: Optional. One of off / fan_only / cool. If omitted, mode is not changed.
    example: cool
  setpoint_entity:
    description: Entity containing target temperature (°C)
    example: input_number.target_temperature
  outdoor_temp_entity:
    description: Outdoor dry-bulb temp sensor (°C)
    example: sensor.viewbank_temp
  outdoor_rh_entity:
    description: Outdoor RH sensor (%)
    example: sensor.viewbank_humidity
  twb_sensor:
    description: >-
      Optional. Wet bulb temperature sensor (°C). If not provided, Twb is
      calculated inline.
    example: sensor.viewbank_wet_bulb_temperature
  fan_mode:
    description: >-
      Optional. If provided, forces this fan speed (string/number 1-10). If
      omitted, Twb scaling is used.
    example: "5"
  aim_offset:
    description: Optional. Adds to setpoint to reduce undershoot.
    example: 0.3
  eta_1:
    description: Optional. Saturation efficiency at fan speed 1
    example: 0.85
  eta_10:
    description: Optional. Saturation efficiency at fan speed 10
    example: 0.65
  min_delta_db_wb:
    description: >-
      Optional. If (B - Twb) < this, treat evap as ineffective and return high
      fan.
    example: 1
  max_increase_step:
    description: >-
      Optional. Maximum fan speed increase from current speed. Prevents noise
      from sudden large increases.
    example: 3
sequence:
  - variables:
      e: "{{ evap_entity }}"
      want_mode: "{{ hvac_mode | default(states(e)) }}"
      forced_fan: "{{ fan_mode | default(none) }}"
      aim_offset_v: "{{ aim_offset | default(0.3) | float }}"
      eta1: "{{ eta_1 | default(0.8) | float }}"
      eta10: "{{ eta_10 | default(0.55) | float }}"
      min_d: "{{ min_delta_db_wb | default(1.0) | float }}"
      max_inc_step: "{{ max_increase_step | default(4) | int }}"
      current_fan: "{{ state_attr(evap_entity, 'fan_mode') | int(1) }}"
      A: "{{ states(setpoint_entity) | float(default=nan) }}"
      B: "{{ states(outdoor_temp_entity) | float(default=nan) }}"
      RH: "{{ states(outdoor_rh_entity) | float(default=nan) }}"
      Twb: |-
        {% if twb_sensor is defined and twb_sensor is not none %}
          {{ states(twb_sensor) | float(default=nan) }}
        {% elif B is not number or RH is not number or RH <= 0 %}
          {{ nan }}
        {% else %}
          {{
            (
              B * (0.151977 * (RH + 8.313659) ** 0.5) | atan
              + (B + RH) | atan
              - (RH - 1.676331) | atan
              + 0.00391838 * RH ** 1.5 * (0.023101 * RH) | atan
              - 4.686035
            )
          }}
        {% endif %}
      desired_fan_calc: |-
        {% if forced_fan is not none %}
          {{ forced_fan | int(1) }}
        {% elif A is not number or B is not number or Twb is not number %}
          5
        {% else %}
          {% set Aaim = A + aim_offset_v %}
          {% set d = B - Twb %}
          {% if d < min_d %}
            10
          {% else %}
            {% set eta_req = (B - Aaim) / d %}
            {% set s = 1 + 9 * (eta1 - eta_req) / (eta1 - eta10) %}
            {{ [1, [10, (s | round(0))] | min] | max }}
          {% endif %}
        {% endif %}
      desired_fan: >-
        {% set base = desired_fan_calc | int(5) %}

        {% set Tin = states('sensor.home_feels_like') | float(default=nan) %}

        {% set err = (Tin - A) if (Tin is number and A is number) else 0 %}


        {# Apply max_increase_step limit to base TWB calculation first #}

        {% set max_allowed_base = current_fan + max_inc_step %}

        {% set base_limited = [1, [10, [base, max_allowed_base] | min] | min] |
        max %}

        

        {% set A = A if (A is number) else nan %}
        {% set aim = (A + aim_offset_v) if (A is number) else nan %}

        {# Search a window around base; widen if you want more authority #}
        {% set lo = [1, base_limited - 3] | max %}
        {% set hi = [10, base_limited + 3] | min %}

        {% set best_fan = base_limited %}
        {% set best_err = 999 %}

        {% for s in range(lo, hi + 1) %}
          {# --- Predict apparent temp at candidate fan s --- #}
          {% set T = states('sensor.home_temperature') | float(default=nan) %}
          {% set RHin = states('sensor.home_humidity') | float(default=nan) %}
          {% set hvac = states(e) %}

          {% if T is number and RHin is number and aim is number %}
            {% set fan_frac = (s - 1) / 9 %}
            {% set cool_temp_drop_max = 3.0 %}
            {% set cool_rh_boost_max = 12.0 %}

            {% set T_eff = T %}
            {% set RH_eff = RHin %}
            {% if hvac == 'cool' %}
              {% set T_eff = T - (cool_temp_drop_max * fan_frac) %}
              {% set RH_eff = [0, [RHin + (cool_rh_boost_max * fan_frac), 100] | min] | max %}
            {% endif %}

            {% set v_min = 0.10 %}
            {% set v_max = 1.50 %}
            {% set v = v_min + (s - 1) * (v_max - v_min) / 9 %}

            {% set es = 6.105 * (2.718281828 ** (17.27 * T_eff / (237.7 + T_eff))) %}
            {% set e_v = (RH_eff / 100.0) * es %}
            {% set AT = T_eff + 0.33 * e_v - 0.70 * v - 4.0 %}

            {# Error relative to target "aim" apparent temp #}
            {% set err = (AT - aim) | abs %}

            {% if err < best_err %}
              {% set best_err = err %}
              {% set best_fan = s %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {{ best_fan }}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ want_mode is not none }}"
        sequence:
          - action: climate.set_hvac_mode
            data:
              entity_id: "{{ e }}"
              hvac_mode: "{{ want_mode }}"
          - wait_template: "{{ states(e) == want_mode }}"
            timeout: "00:00:15"
            continue_on_timeout: true
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ want_mode is not none and want_mode != 'off' }}"
        sequence:
          - repeat:
              until:
                - condition: template
                  value_template: >-
                    {{ state_attr(e,'fan_mode') == (desired_fan | string) or
                    repeat.index >= 20 }}
              sequence:
                - action: climate.set_fan_mode
                  data:
                    entity_id: "{{ e }}"
                    fan_mode: "{{ desired_fan }}"
                - delay: "00:00:01"
description: ""
