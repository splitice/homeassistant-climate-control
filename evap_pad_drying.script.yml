alias: evap_pad_drying
description: "Manage evaporative cooler pad drying cycle with progress tracking"
mode: queued
fields:
  evap_entity:
    description: Climate entity
    example: climate.evap
    required: true
  pad_drying_entity:
    description: Number input entity to track pad drying progress (0-100%)
    example: input_number.pad_drying_progress
    required: true
  pad_dry_time_speed1:
    description: Minimum time in minutes to run fan_only for pad drying at speed 1
    example: 10
  pad_dry_time_speed10:
    description: Minimum time in minutes to run fan_only for pad drying at speed 10
    example: 5
  pad_drying_previous:
    description: Unix timestamp of when pad drying started. If 0, drying has not started.
    example: 1704067200
    required: true
  setpoint_entity:
    description: Entity containing target temperature (Â°C)
    example: input_number.target_temperature
    required: true
  indoor_temp_entity:
    description: Indoor temperature sensor
    example: sensor.home_temperature
    required: true
  min_fan_speed_entity:
    description: Optional. Entity defining minimum fan speed (1-10)
    example: input_number.min_fan_speed
  max_fan_speed_entity:
    description: Optional. Entity defining maximum fan speed (1-10)
    example: input_number.max_fan_speed
sequence:
  - variables:
      e: "{{ evap_entity }}"
      cur_mode: "{{ states(evap_entity) }}"
      current_fan_speed: "{{ state_attr(evap_entity, 'fan_mode') | int(1) }}"
      pad_dry_percent: "{{ states(pad_drying_entity) | float(0) }}"
      dry_time_1: "{{ pad_dry_time_speed1 | default(10) | float }}"
      dry_time_10: "{{ pad_dry_time_speed10 | default(5) | float }}"
      setpoint_temp: "{{ states(setpoint_entity) | float(22) }}"
      indoor_temp: "{{ states(indoor_temp_entity) | float(22) }}"
      pad_start_time: "{{ pad_drying_previous | int(0) }}"
  
  # If pad drying complete, turn off and exit
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ pad_dry_percent >= 100 }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ cur_mode != 'off' }}"
                sequence:
                  - action: script.evap_set_evap_target
                    data:
                      evap_entity: "{{ e }}"
                      target_mode: "off"
                      target_speed: -1
                      min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
                      max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
          - stop: Pad drying complete
  
  # Ensure in fan_only mode
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ cur_mode != 'fan_only' }}"
        sequence:
          - choose:
              # If coming from off, start at speed 2
              - conditions:
                  - condition: template
                    value_template: "{{ cur_mode == 'off' }}"
                sequence:
                  - action: script.evap_set_evap_target
                    data:
                      evap_entity: "{{ e }}"
                      target_mode: "fan_only"
                      target_speed: 2
                      min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
                      max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
            # Otherwise keep current fan speed
            default:
              - action: script.evap_set_evap_target
                data:
                  evap_entity: "{{ e }}"
                  target_mode: "fan_only"
                  target_speed: -1
                  min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
                  max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
  
  # Update pad drying progress
  - variables:
      new_percent_dried: |-
        {% if pad_start_time == 0 %}
          0
        {% else %}
          {% set elapsed_seconds = as_timestamp(now()) - pad_start_time %}
          {% set elapsed_minutes = elapsed_seconds / 60 %}
          {% set current_fan = state_attr(evap_entity, 'fan_mode') | int(1) %}
          {% set dry_time_minutes = dry_time_1 + (current_fan - 1) * (dry_time_10 - dry_time_1) / 9 %}
          {% set percent_delta = (elapsed_minutes / dry_time_minutes) * 100 %}
          {% set new_total = pad_dry_percent + percent_delta %}
          {{ [100, new_total] | min }}
        {% endif %}
  
  - action: input_number.set_value
    data:
      entity_id: "{{ pad_drying_entity }}"
      value: "{{ new_percent_dried }}"
  
  # Determine if we should lower fan speed
  - variables:
      should_lower_fan: "{{ (setpoint_temp - indoor_temp) > 0 or pad_dry_percent >= 80 }}"
      target_speed_lower: "{{ [1, current_fan_speed - 1] | max }}"
  
  # Lower fan speed if conditions met
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ should_lower_fan and target_speed_lower != current_fan_speed }}"
        sequence:
          - action: script.evap_set_evap_target
            data:
              evap_entity: "{{ e }}"
              target_mode: "fan_only"
              target_speed: "{{ target_speed_lower }}"
              min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
              max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
