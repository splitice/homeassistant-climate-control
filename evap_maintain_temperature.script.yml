alias: evap_maintain_temperature_v4
description: "Maintain target temperature with minimal fan speed changes (v4)"
mode: queued
fields:
  evap_entity:
    description: Climate entity
    example: climate.evap
    required: true
  setpoint_entity:
    description: Entity containing target temperature (°C)
    example: input_number.target_temperature
    required: true
  outdoor_temp_entity:
    description: Outdoor dry-bulb temp sensor (°C)
    example: sensor.viewbank_temp
    required: true
  outdoor_humidity_entity:
    description: Outdoor RH sensor (%)
    example: sensor.viewbank_humidity
    required: true
  indoor_temperature_entity:
    description: Indoor temperature sensor
    example: sensor.home_temperature
    required: true
  indoor_humidity_entity:
    description: Indoor RH sensor (%)
    example: sensor.home_humidity
    required: true
  at_target:
    description: Boolean indicating if current temperature is within deadband
    example: true
    required: true
  deadband_cooling_upper:
    description: Upper deadband (°C) for cooling decisions
    example: 0.3
  deadband_cooling_lower:
    description: Lower deadband (°C) for cooling decisions
    example: 0
  min_fan_speed_entity:
    description: Optional. Entity defining minimum fan speed (1-10)
    example: input_number.min_fan_speed
  max_fan_speed_entity:
    description: Optional. Entity defining maximum fan speed (1-10)
    example: input_number.max_fan_speed
  temperature_change_per_minute:
    description: Temperature change rate (°C/min), -999 if not available
    example: -0.5
    required: true
sequence:
  - variables:
      e: "{{ evap_entity }}"
      current_fan_speed: "{{ state_attr(evap_entity, 'fan_mode') | int(1) }}"
      setpoint: "{{ states(setpoint_entity) | float(22) }}"
      outdoor_temp: "{{ states(outdoor_temp_entity) | float(30) }}"
      outdoor_rh: "{{ states(outdoor_humidity_entity) | float(50) }}"
      indoor_temp: "{{ states(indoor_temperature_entity) | float(22) }}"
      indoor_rh: "{{ states(indoor_humidity_entity) | float(50) }}"
      temp_change_rate: "{{ temperature_change_per_minute | float(-999) }}"
      deadband_upper: "{{ deadband_cooling_upper | default(0.3) | float }}"
      deadband_lower: "{{ deadband_cooling_lower | default(0) | float }}"
      is_at_target: "{{ at_target }}"
      
      # Calculate wet bulb temperature using Stull approximation
      wet_bulb_temp: |-
        {% set B = outdoor_temp %}
        {% set RH = outdoor_rh %}
        {% if RH > 0 %}
          {{
            (
              B * (0.151977 * (RH + 8.313659) ** 0.5) | atan
              + (B + RH) | atan
              - (RH - 1.676331) | atan
              + 0.00391838 * RH ** 1.5 * (0.023101 * RH) | atan
              - 4.686035
            )
          }}
        {% else %}
          {{ B }}
        {% endif %}
  
  # Calculate feels like temperature at current fan speed
  - variables:
      current_feels_like: |-
        {# -----------------------------
          Inputs
          ----------------------------- #}
        {% set T_in = states(indoor_temperature_entity) | float(default=nan) %}
        {% set RH_in = states(indoor_humidity_entity) | float(default=nan) %}

        {% set B = states(outdoor_temp_entity) | float(default=nan) %}        {# outdoor dry-bulb #}
        {% set RH_out = states(outdoor_humidity_entity) | float(default=nan) %}

        {% set mode = states(evap_entity) %}
        {% set fan_raw = state_attr(evap_entity, 'fan_mode') %}
        {% set fan = fan_raw | int(0) %}

        {# -----------------------------
          Tunables (make these input_numbers later if you like)
          ----------------------------- #}
        {% set eta1 = 0.75 %}                 {# effective saturation efficiency @ fan 1 (more pessimistic than ideal) #}
        {% set eta10 = 0.55 %}                {# effective saturation efficiency @ fan 10 #}
        {% set supply_heat_gain = 1.0 %}      {# °C added to predicted supply to account for duct/roof heat gain (your ~+1.1°C) #}

        {% set mix_max = 0.55 %}              {# 0..1: how much supply temp can influence "effective" indoor temp at fan 10 #}
        {% set rh_boost_max = 6.0 %}          {# %RH increase at fan 10 when cooling (optional, small) #}

        {% set v_min = 0.10 %}
        {% set v_max = 1.50 %}

        {# -----------------------------
          Handle inactive states
          ----------------------------- #}
        {% set evap_active =
            (mode in ['cool','fan_only'])
            and (fan_raw not in [none, 'off', '0', 0])
            and (fan > 0)
        %}

        {# Base apparent temperature (no fan effect) #}
        {% if T_in is not number or RH_in is not number %}
          {{ nan }}
        {% else %}
          {% set e_constant = 2.718281828 %}
          {% set es0 = 6.105 * (e_constant ** (17.27 * T_in / (237.7 + T_in))) %}
          {% set e0 = (RH_in / 100.0) * es0 %}
          {% set AT_base = T_in + 0.33 * e0 - 4.0 %}

          {% if not evap_active %}
            {{ AT_base | round(1) }}
          {% else %}

            {# -----------------------------
              Fan normalisation
              ----------------------------- #}
            {% set fan = [1, [fan, 10] | min] | max %}
            {% set fan_frac = (fan - 1) / 9 %}

            {# -----------------------------
              Wet-bulb (Stull) with correct atan placement
              ----------------------------- #}
            {% set Twb =
              (
                (B * ((0.151977 * (RH_out + 8.313659) ** 0.5) | atan))
                + ((B + RH_out) | atan)
                - ((RH_out - 1.676331) | atan)
                + (0.00391838 * RH_out ** 1.5 * ((0.023101 * RH_out) | atan))
                - 4.686035
              )
            if (B is number and RH_out is number and RH_out > 0)
            else nan %}

            {# If we can't compute Twb, fall back to old AT with airspeed only #}
            {% if Twb is not number %}
              {% set v = v_min + fan_frac * (v_max - v_min) %}
              {% set es = 6.105 * (e_constant ** (17.27 * T_in / (237.7 + T_in))) %}
              {% set e = (RH_in / 100.0) * es %}
              {% set AT = T_in + 0.33 * e - 0.70 * v - 4.0 %}
              {{ AT | round(1) }}
            {% else %}

              {# -----------------------------
                Predict supply temperature from Twb + efficiency
                Ts = B - eta*(B - Twb) + heat_gain
                eta interpolated fan1..fan10
                ----------------------------- #}
              {% set eta = eta1 + (eta10 - eta1) * fan_frac %}
              {% set Ts_pred = (B - eta * (B - Twb)) + supply_heat_gain %}

              {# -----------------------------
                Mixing model: effective indoor temp shifts toward Ts_pred as fan increases
                mix_coeff 0..mix_max (fan dependent)
                ----------------------------- #}
              {% set mix_coeff = mix_max * fan_frac %}
              {% set T_eff = T_in - mix_coeff * (T_in - Ts_pred) %}

              {# Optional: humidity rises a bit in cool mode (keep small)
                Use indoor RH as baseline; just nudge it a bit for comfort calculation.
              #}
              {% set RH_eff = RH_in %}
              {% if mode == 'cool' %}
                {% set RH_eff = [0, [RH_in + (rh_boost_max * fan_frac), 100] | min] | max %}
              {% endif %}

              {# Airspeed term #}
              {% set v = v_min + fan_frac * (v_max - v_min) %}

              {# Steadman apparent temp using T_eff + RH_eff + v #}
              {% set es = 6.105 * (e_constant ** (17.27 * T_eff / (237.7 + T_eff))) %}
              {% set e = (RH_eff / 100.0) * es %}
              {% set AT = T_eff + 0.33 * e - 0.70 * v - 4.0 %}

              {{ AT | round(1) }}
            {% endif %}
          {% endif %}
        {% endif %}
      diff: "{{ current_feels_like - setpoint }}"
  
  # Determine target mode and speed
  - variables:
      target_mode: |-
        {% if not is_at_target and diff < -0.9 and current_fan_speed <= 2 %}
          fan_only
        {% else %}
          cool
        {% endif %}
      
      # Target speed algorithm based on temperature change rate or feels like comparison
      target_speed: |-
        {% if temp_change_rate != -999 %}
          {# Use temperature change rate if available #}
          {% if diff > (deadband_upper * 2) %}
            {{ [10, current_fan_speed + 1] | min }}
          {% elif diff < (deadband_lower * 2) %}
            {{ [1, current_fan_speed - 1] | max }}
          {% elif temp_change_rate < -0.25 and diff < 0 %}
            {# Getting cooler and already too cold #}
            {{ [1, current_fan_speed - 1] | max }}
          {% elif temp_change_rate > 0.25 and diff > 0 %}
            {# Getting warmer and already too warm #}
            {{ [10, current_fan_speed + 1] | min }}
          {% else %}
            {{ current_fan_speed }}
          {% endif %}
        {% else %}
          {# Compare feels like at -1, current, +1 fan speeds #}
          {% set speeds_to_test = [
            [1, current_fan_speed - 1] | max,
            current_fan_speed,
            [10, current_fan_speed + 1] | min
          ] %}
          {% set best_speed = current_fan_speed %}
          {% set best_error = 999 %}
          
          {% for test_speed in speeds_to_test %}
            {% set T = indoor_temp %}
            {% set RH = indoor_rh %}
            {% set fan_frac = (test_speed - 1) / 9 %}
            {% set cool_temp_drop_max = 4.0 %}
            {% set T_eff = T - (cool_temp_drop_max * fan_frac) %}
            {% set v_min = 0.10 %}
            {% set v_max = 1.50 %}
            {% set v = v_min + (test_speed - 1) * (v_max - v_min) / 9 %}
            {# Euler's number for saturation vapor pressure calculation #}
            {% set e_constant = 2.71828 %}
            {% set es = 6.105 * (e_constant ** (17.27 * T_eff / (237.7 + T_eff))) %}
            {% set e = (RH / 100.0) * es %}
            {% set AT = T_eff + 0.33 * e - 0.70 * v - 4.0 %}
            {% set error = (AT - setpoint) | abs %}
            
            {% if error < best_error %}
              {% set best_error = error %}
              {% set best_speed = test_speed %}
            {% endif %}
          {% endfor %}
          
          {{ best_speed }}
        {% endif %}
  
  # Apply target mode and speed
  - action: script.evap_set_evap_target
    data:
      evap_entity: "{{ e }}"
      target_mode: "{{ target_mode }}"
      target_speed: "{{ target_speed }}"
      min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
      max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
