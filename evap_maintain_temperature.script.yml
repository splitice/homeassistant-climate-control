alias: evap_maintain_temperature
mode: queued
fields:
  evap_entity:
    description: Climate entity
    example: climate.evap
  hvac_mode:
    description: Optional. One of off / fan_only / cool. If omitted, mode is not changed.
    example: cool
  setpoint_entity:
    description: Entity containing target temperature (°C)
    example: input_number.target_temperature
  outdoor_temp_entity:
    description: Outdoor dry-bulb temp sensor (°C)
    example: sensor.viewbank_temp
  twb_sensor:
    description: Wet bulb temperature sensor (°C)
    example: sensor.evap_twb_viewbank
  fan_mode:
    description: >-
      Optional. If provided, forces this fan speed (string/number 1-10). If
      omitted, Twb scaling is used with minimal adjustments.
    example: "5"
  aim_offset:
    description: Optional. Target offset to prevent oscillation. Defaults to 0.15°C for maintain mode.
    example: 0.15
  eta_1:
    description: Optional. Saturation efficiency at fan speed 1
    example: 0.85
  eta_10:
    description: Optional. Saturation efficiency at fan speed 10
    example: 0.65
  min_delta_db_wb:
    description: >-
      Optional. If (B - Twb) < this, treat evap as ineffective and return high
      fan.
    example: 1
  fan_change_threshold:
    description: >-
      Optional. Temperature error (°C) required to change fan speed. Defaults to 0.2°C.
      This prevents frequent fan speed changes when maintaining temperature.
    example: 0.2
sequence:
  - variables:
      e: "{{ evap_entity }}"
      want_mode: "{{ hvac_mode | default(none) }}"
      forced_fan: "{{ fan_mode | default(none) }}"
      aim_offset_v: "{{ aim_offset | default(0.15) | float }}"
      eta1: "{{ eta_1 | default(0.85) | float }}"
      eta10: "{{ eta_10 | default(0.65) | float }}"
      min_d: "{{ min_delta_db_wb | default(1.0) | float }}"
      fan_threshold: "{{ fan_change_threshold | default(0.2) | float }}"
      current_fan: "{{ state_attr(evap_entity, 'fan_mode') | int(1) }}"
      A: "{{ states(setpoint_entity) | float(default=nan) }}"
      B: "{{ states(outdoor_temp_entity) | float(default=nan) }}"
      Twb: "{{ states(twb_sensor) | float(default=nan) }}"
      Tin: "{{ states('sensor.home_temperature') | float(default=nan) }}"
      temp_error: "{{ (Tin - A) if (Tin is number and A is number) else 0 }}"
      desired_fan_calc: |-
        {% if forced_fan is not none %}
          {{ forced_fan | int(1) }}
        {% elif A is not number or B is not number or Twb is not number %}
          {{ current_fan }}
        {% else %}
          {% set Aaim = A + aim_offset_v %}
          {% set d = B - Twb %}
          {% if d < min_d %}
            10
          {% else %}
            {% set eta_req = (B - Aaim) / d %}
            {% set s = 1 + 9 * (eta1 - eta_req) / (eta1 - eta10) %}
            {{ [1, [10, (s | round(0))] | min] | max }}
          {% endif %}
        {% endif %}
      # In maintain mode, only change fan speed if temperature error exceeds threshold
      desired_fan: |-
        {% set base = desired_fan_calc | int(current_fan) %}
        {% set err = temp_error | float(0) %}
        
        {# If temperature is within threshold of setpoint, maintain current fan speed #}
        {% if err | abs <= fan_threshold %}
          {{ current_fan }}
        {# Only increase fan if temperature rises significantly above setpoint #}
        {% elif err > fan_threshold %}
          {# Temperature is too high, increase fan speed by 1 step max #}
          {{ [10, current_fan + 1, base] | max }}
        {# Only decrease fan if temperature is well below setpoint #}
        {% elif err < -fan_threshold %}
          {# Temperature is comfortably below setpoint, can decrease by 1 step #}
          {{ [1, current_fan - 1] | max }}
        {% else %}
          {{ current_fan }}
        {% endif %}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ want_mode is not none }}"
        sequence:
          - action: climate.set_hvac_mode
            data:
              entity_id: "{{ e }}"
              hvac_mode: "{{ want_mode }}"
          - wait_template: "{{ states(e) == want_mode }}"
            timeout: "00:00:15"
            continue_on_timeout: true
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ want_mode is not none and want_mode == 'off' }}"
        sequence:
          - repeat:
              until:
                - condition: template
                  value_template: >-
                    {{ state_attr(e,'fan_mode') == (desired_fan | string) or
                    repeat.index >= 20 }}
              sequence:
                - action: climate.set_fan_mode
                  data:
                    entity_id: "{{ e }}"
                    fan_mode: "{{ desired_fan }}"
                - delay: "00:00:01"
      - conditions:
          - condition: template
            value_template: "{{ desired_fan != current_fan }}"
        sequence:
          - repeat:
              until:
                - condition: template
                  value_template: >-
                    {{ state_attr(e,'fan_mode') == (desired_fan | string) or
                    repeat.index >= 20 }}
              sequence:
                - action: climate.set_fan_mode
                  data:
                    entity_id: "{{ e }}"
                    fan_mode: "{{ desired_fan }}"
                - delay: "00:00:01"
description: >-
  Maintain temperature mode with minimal fan speed changes. Only adjusts fan speed
  when temperature error exceeds threshold (default 0.2°C). Uses wet bulb temperature
  sensor for efficiency calculations and maintains stable operation.
