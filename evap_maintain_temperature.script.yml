alias: evap_maintain_temperature_v4
description: Maintain target temperature with minimal fan speed changes (v4)
mode: queued
fields:
  evap_entity:
    description: Mode select entity
    example: select.roofevap1_e90248_evap_mode
    required: true
  fan_speed_entity:
    description: Fan speed select entity
    example: select.roofevap1_e90248_evap_fan_speed
    required: true
  setpoint_entity:
    description: Entity containing target temperature (°C)
    example: input_number.target_temperature
    required: true
  outdoor_temp_entity:
    description: Outdoor dry-bulb temp sensor (°C)
    example: sensor.viewbank_temp
    required: true
  outdoor_humidity_entity:
    description: Outdoor RH sensor (%)
    example: sensor.viewbank_humidity
    required: true
  indoor_temperature_entity:
    description: Indoor temperature sensor
    example: sensor.home_temperature
    required: true
  indoor_humidity_entity:
    description: Indoor RH sensor (%)
    example: sensor.home_humidity
    required: true
  at_target:
    description: Boolean indicating if current temperature is within deadband
    example: true
    required: true
  deadband_cooling_upper:
    description: Upper deadband (°C) for cooling decisions
    example: 0.3
  deadband_cooling_lower:
    description: Lower deadband (°C) for cooling decisions
    example: 0
  min_fan_speed_entity:
    description: Optional. Entity defining minimum fan speed (1-10)
    example: input_number.min_fan_speed
  max_fan_speed_entity:
    description: Optional. Entity defining maximum fan speed (1-10)
    example: input_number.max_fan_speed
  temperature_change_per_minute:
    description: Temperature change rate (°C/min), -999 if not available
    example: -0.5
    required: true
  allowed_cool:
    description: Boolean indicating if cooling mode is allowed
    example: true
    required: true
sequence:
  - variables:
      mode_entity: "{{ evap_entity }}"
      speed_entity: "{{ fan_speed_entity }}"
      current_fan_speed: "{{ states(fan_speed_entity) | int(1) }}"
      current_mode: "{{ states(evap_entity) }}"
      setpoint: "{{ states(setpoint_entity) | float(22) }}"
      outdoor_temp: "{{ states(outdoor_temp_entity) | float(30) }}"
      outdoor_rh: "{{ states(outdoor_humidity_entity) | float(50) }}"
      indoor_temp: "{{ states(indoor_temperature_entity) | float(22) }}"
      indoor_rh: "{{ states(indoor_humidity_entity) | float(50) }}"
      temp_change_rate: "{{ temperature_change_per_minute | float(-999) }}"
      deadband_upper: "{{ deadband_cooling_upper | default(0.3) | float }}"
      deadband_lower: "{{ deadband_cooling_lower | default(0) | float }}"
      is_at_target: "{{ at_target }}"
      wet_bulb_temp: |-
        {% set B = outdoor_temp %}
        {% set RH = outdoor_rh %}
        {% if RH > 0 %}
          {{
            (
              B * (0.151977 * (RH + 8.313659) ** 0.5) | atan
              + (B + RH) | atan
              - (RH - 1.676331) | atan
              + 0.00391838 * RH ** 1.5 * (0.023101 * RH) | atan
              - 4.686035
            )
          }}
        {% else %}
          {{ B }}
        {% endif %}
      current_feels_like: "{{ states('sensor.home_feels_like') }}"
      diff: "{{ current_feels_like - setpoint }}"
      target_mode: |-
        {% set indoor_temp_delta_val = setpoint - indoor_temp %}
        {% set outdoor_temp_delta_val = outdoor_temp - setpoint %}
        {% set humidity_diff = indoor_rh - outdoor_rh %}
        {% if current_mode == 'cool' and indoor_temp_delta_val >= 3.0 and diff < deadband_upper and outdoor_temp_delta_val <= (indoor_temp_delta_val / 2.0) and humidity_diff > 10 and indoor_rh > 50 %}
          fan_only
        {% elif not is_at_target and diff < -0.3 and current_fan_speed <= 2 %}
          fan_only
        {% elif outdoor_temp > indoor_temp and allowed_cool %}
          cool
        {% elif diff < 0 %}
          {{ current_mode }}
        {% elif allowed_cool %}
          cool
        {% else %}
          fan_only
        {% endif %}
      target_speed: |-
        {% set indoor_temp_delta_val = setpoint - indoor_temp %}
        {% set outdoor_temp_delta_val = outdoor_temp - setpoint %}
        {% set humidity_diff = indoor_rh - outdoor_rh %}
        {% set dehumidify_mode = current_mode == 'cool' and indoor_temp_delta_val >= 3.0 and diff < deadband_upper and outdoor_temp_delta_val <= (indoor_temp_delta_val / 2.0) and humidity_diff > 10 and indoor_rh > 50 %}
        {% if dehumidify_mode %}
          {# Dehumidify mode: reduce fan speed by 1 #}
          {{ [1, current_fan_speed - 1] | max }}
        {% elif temp_change_rate != -999 %}
          {# Use temperature change rate if available #}
          {% set min_speed = 0 if current_mode == 'off' else 1 %}
          {% if diff > (deadband_upper * 2) %}
            {{ [10, current_fan_speed + 1] | min }}
          {% elif diff < (deadband_lower * 2) %}
            {{ [min_speed, current_fan_speed - 1] | max }}
          {% elif temp_change_rate < -0.25 and diff < 0 %}
            {# Getting cooler and already too cold #}
            {{ [min_speed, current_fan_speed - 1] | max }}
          {% elif temp_change_rate > 0.25 and diff > 0 %}
            {# Getting warmer and already too warm #}
            {{ [10, current_fan_speed + 1] | min }}
          {% else %}
            {{ current_fan_speed }}
          {% endif %}
        {% else %}
          {# Compare feels like at -1, current, +1 fan speeds #}
          {# If current mode is off, include fan speed 0 (off) as a valid option #}
          {% if current_mode == 'off' %}
            {% set speeds_to_test = [
              0,
              [1, current_fan_speed - 1] | max,
              current_fan_speed,
              [10, current_fan_speed + 1] | min
            ] %}
          {% else %}
            {% set speeds_to_test = [
              [1, current_fan_speed - 1] | max,
              current_fan_speed,
              [10, current_fan_speed + 1] | min
            ] %}
          {% endif %}
          {% set best_speed = current_fan_speed %}
          {% set best_error = 999 %}
          
          {% for test_speed in speeds_to_test %}
            {% set T = indoor_temp %}
            {% set RH = indoor_rh %}
            
            {# For fan speed 0 (off), there's no cooling or forced airflow #}
            {% if test_speed == 0 %}
              {% set T_eff = T %}
              {% set v = 0.0 %}  {# No forced airflow #}
            {% else %}
              {% set fan_frac = (test_speed - 1) / 9 %}
              {% set cool_temp_drop_max = 4.0 %}
              {% set T_eff = T - (cool_temp_drop_max * fan_frac) %}
              {% set v_min = 0.10 %}
              {% set v_max = 1.50 %}
              {% set v = v_min + (test_speed - 1) * (v_max - v_min) / 9 %}
            {% endif %}
            
            {# Euler's number for saturation vapor pressure calculation #}
            {% set e_constant = 2.71828 %}
            {% set es = 6.105 * (e_constant ** (17.27 * T_eff / (237.7 + T_eff))) %}
            {# Quadratic RH scaling above threshold #}
            {% set RH0 = 60.0 %}
            {% set k = 0.1 %}
            {% set rh = RH | float %}
            {% set rh_lin = (rh / 100.0) %}
            {% set rh_extra = ((max(0.0, rh - RH0) / (100.0 - RH0)) ** 2) %}
            {% set e = es * (rh_lin + k * rh_extra) %}
            {% set AT = T_eff + 0.33 * e - 0.70 * v - 4.0 %}
            {% set error = (AT - setpoint) | abs %}
            
            {% if error < best_error %}
              {% set best_error = error %}
              {% set best_speed = test_speed %}
            {% endif %}
          {% endfor %}
          
          {{ best_speed }}
        {% endif %}
  - action: script.evap_set_evap_target
    data:
      evap_entity: "{{ mode_entity }}"
      fan_speed_entity: "{{ speed_entity }}"
      target_mode: "{{ 'off' if target_speed == 0 else target_mode }}"
      target_speed: "{{ target_speed }}"
      min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
      max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
