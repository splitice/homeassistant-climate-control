alias: evap_get_to_target_temperature
description: "Aggressively cool to reach target temperature (v4)"
mode: queued
fields:
  evap_entity:
    description: Climate entity
    example: climate.evap
    required: true
  setpoint_entity:
    description: Entity containing target temperature (°C)
    example: input_number.target_temperature
    required: true
  outdoor_temp_entity:
    description: Outdoor dry-bulb temp sensor (°C)
    example: sensor.viewbank_temp
    required: true
  outdoor_humidity_entity:
    description: Outdoor RH sensor (%)
    example: sensor.viewbank_humidity
    required: true
  indoor_temperature_entity:
    description: Indoor temperature sensor
    example: sensor.home_temperature
    required: true
  indoor_humidity_entity:
    description: Indoor RH sensor (%)
    example: sensor.home_humidity
    required: true
  min_fan_speed_entity:
    description: Optional. Entity defining minimum fan speed (1-10)
    example: input_number.min_fan_speed
  max_fan_speed_entity:
    description: Optional. Entity defining maximum fan speed (1-10)
    example: input_number.max_fan_speed
sequence:
  - variables:
      e: "{{ evap_entity }}"
      current_fan_speed: "{{ state_attr(evap_entity, 'fan_mode') | int(1) }}"
      setpoint: "{{ states(setpoint_entity) | float(22) }}"
      outdoor_temp: "{{ states(outdoor_temp_entity) | float(30) }}"
      outdoor_rh: "{{ states(outdoor_humidity_entity) | float(50) }}"
      indoor_temp: "{{ states(indoor_temperature_entity) | float(22) }}"
      indoor_rh: "{{ states(indoor_humidity_entity) | float(50) }}"
      current_feels_like: "{{ states('sensor.home_feels_like') | float(default=nan) }}"
      
      # Calculate wet bulb temperature using Stull approximation
      wet_bulb_temp: |-
        {% set B = outdoor_temp %}
        {% set RH = outdoor_rh %}
        {% if RH > 0 %}
          {{
            (
              B * (0.151977 * (RH + 8.313659) ** 0.5) | atan
              + (B + RH) | atan
              - (RH - 1.676331) | atan
              + 0.00391838 * RH ** 1.5 * (0.023101 * RH) | atan
              - 4.686035
            )
          }}
        {% else %}
          {{ B }}
        {% endif %}
      
      diff: "{{ current_feels_like - setpoint }}"
      
      # Calculate target_minutes: max(3, 3-(diff * 0.5))
      target_minutes: "{{ [3, 3 - (diff * 0.5)] | max }}"
      target_mode: |-
        {# Switch to fan_only if indoor temp is at/near setpoint but feels like is high due to RH #}
        {% set temp_at_target = (indoor_temp - setpoint) < 0.5 %}
        {% if temp_at_target and current_feels_like > setpoint %}
          fan_only
        {% else %}
          cool
        {% endif %}
      target_speed: |-
        {# ----------------------------
          Aggressive get-to-target fan selection
          Predicts feels like temp at each fan speed, not just supply temp
          Uses mixing model + RH effects like sensor.home_feels_like
          ---------------------------- #}
  
        {% set best_speed = 10 %}
        {% set best_time_error = 999 %}
        {% set best_minutes = 999 %}
  
        {# Inputs (expected provided by your script context) #}
        {% set T_in_raw = indoor_temp | float(default=nan) %}
        {% set RH_in = indoor_rh | float(default=nan) %}
        {% set current_FL = current_feels_like | float(default=nan) %}
        {% set A = setpoint | float(default=nan) %}
        {% set B = outdoor_temp | float(default=nan) %}
        {% set RH_out = outdoor_rh | float(default=nan) %}
  
        {# Tunables (match sensor.home_feels_like.yml) #}
        {% set eta1 = 0.75 %}     {# effective whole-system efficiency at fan 1 #}
        {% set eta10 = 0.5 %}     {# ...at fan 10 (match sensor) #}
        {% set tau_1 = 60.0 %}    {# minutes at fan 1 #}
        {% set tau_10 = 14.0 %}   {# minutes at fan 10; lower = more aggressive #}
        {% set min_delta = 0.3 %} {# °C #}
        
        {# Feels like calculation parameters (from sensor) #}
        {% set mix_max = 0.55 %}
        {% set rh_boost_max = 6.0 %}
        {% set v_min = 0.5 %}
        {% set v_max = 4.0 %}
        {% set RH0 = 60.0 %}
        {% set k = 0.4 %}
        {% set e_constant = 2.718281828 %}
  
        {# If missing inputs, fall back to push hard #}
        {% if current_FL is not number or A is not number or B is not number or RH_out is not number %}
          {% set best_speed = 10 %}
        {% else %}
  
          {# --- Wet-bulb (Stull) with correct atan placement --- #}
          {% set Twb =
            (
              (B * ((0.151977 * (RH_out + 8.313659) ** 0.5) | atan))
              + ((B + RH_out) | atan)
              - ((RH_out - 1.676331) | atan)
              + (0.00391838 * RH_out ** 1.5 * ((0.023101 * RH_out) | atan))
              - 4.686035
            )
          %}
  
          {# --- Supply heat gain model (linear, clamped, anchor at 35C -> 1.5C) --- #}
          {% set gain_min = 0.0 %}
          {% set gain_max = 2.0 %}
          {% set T_low = 23.0 %}
          {% set T_high = 40.0 %}
          {% set T_anchor = 35.0 %}
          {% set gain_anchor = 1.5 %}
          {% set slope = (gain_anchor - gain_min) / (T_anchor - T_low) %}
          {% if B is not number %}
            {% set supply_heat_gain = gain_anchor %}
          {% else %}
            {% set raw = gain_min + slope * (B - T_low) %}
            {% set supply_heat_gain = [gain_min, [raw, gain_max] | min] | max %}
          {% endif %}
  
          {# If already at/below setpoint, choose minimum #}
          {% if current_FL <= A %}
            {% set best_speed = 1 %}
          {% else %}
  
            {# Test fan speeds from 1..10 #}
            {% for test_speed in range(1, 11) %}
              {# Fan normalization (match sensor logic) #}
              {% set fan = [1, [test_speed, 10] | min] | max %}
              {% set fan_frac = (fan - 1) / 11 %}
              {% if fan > 0 %}
                {% set fan_frac = fan_frac + 2/11 %}
              {% endif %}
  
              {# Efficiency at this fan #}
              {% set eta = eta1 + (eta10 - eta1) * fan_frac %}
  
              {# Predicted supply temp at this fan (roof heat gain included) #}
              {% set Ts_pred = (B - eta * (B - Twb)) + supply_heat_gain %}
              
              {# Calculate predicted feels like at this fan speed (match sensor) #}
              {# Mixing model: effective indoor temp shifts toward Ts_pred #}
              {% set mix_coeff = mix_max * fan_frac %}
              {% set T_eff = T_in_raw - mix_coeff * (T_in_raw - Ts_pred) %}
              
              {# RH increases slightly in cool mode #}
              {% set RH_eff = [0, [RH_in + (rh_boost_max * fan_frac), 100] | min] | max %}
              
              {# Airspeed term #}
              {% set v = v_min + fan_frac * (v_max - v_min) %}
              
              {# Steadman apparent temp using T_eff + RH_eff + v (quadratic RH scaling) #}
              {% set es = 6.105 * (e_constant ** (17.27 * T_eff / (237.7 + T_eff))) %}
              {% set rh = RH_eff | float %}
              {% set rh_lin = (rh / 100.0) %}
              {% set rh_extra = ((max(0.0, rh - RH0) / (100.0 - RH0)) ** 2) %}
              {% set e = es * (rh_lin + k * rh_extra) %}
              {% set predicted_FL = T_eff + 0.3 * e - 0.80 * v - 4.0 %}
  
              {# Driving delta: current feels like above predicted feels like #}
              {% set dT = current_FL - predicted_FL %}
  
              {# Fan-dependent time constant (linear interpolation) #}
              {% set tau = tau_1 + (tau_10 - tau_1) * ((test_speed - 1) / 9) %}
  
              {# First-order time to reach setpoint (using feels like temp):
                FL(t) = predicted_FL + (current_FL - predicted_FL)*exp(-t/tau)
                => t = -tau * ln((A - predicted_FL)/(current_FL - predicted_FL))
              #}
              {% if dT > min_delta and A > predicted_FL and current_FL > A %}
                {% set ratio = (A - predicted_FL) / (current_FL - predicted_FL) %}
                {% if ratio > 0 and ratio < 1 %}
                  {% set estimated_minutes = (-tau * (ratio | log)) %}
                {% else %}
                  {% set estimated_minutes = 999 %}
                {% endif %}
              {% else %}
                {% set estimated_minutes = 999 %}
              {% endif %}
  
              {# Choose the LOWEST speed that meets target_minutes (aggressive),
                else track closest time #}
              {% if estimated_minutes <= target_minutes %}
                {% set best_speed = test_speed %}
                {% set best_minutes = estimated_minutes %}
                {% set best_time_error = 0 %}
                {% break %}
              {% else %}
                {% set time_error = (estimated_minutes - target_minutes) | abs %}
                {% if time_error < best_time_error %}
                  {% set best_time_error = time_error %}
                  {% set best_speed = test_speed %}
                  {% set best_minutes = estimated_minutes %}
                {% endif %}
              {% endif %}
            {% endfor %}
  
            {# If we couldn't compute anything sensible, push hard #}
            {% if best_minutes >= 900 %}
              {% set best_speed = 10 %}
            {% endif %}
  
          {% endif %}
        {% endif %}
  
        {# Cap speed change to max ±2 from current #}
        {% if best_speed > current_fan_speed + 2 %}
          {{ current_fan_speed + 2 }}
        {% elif best_speed < current_fan_speed - 2 %}
          {{ current_fan_speed - 2 }}
        {% else %}
          {{ best_speed }}
        {% endif %}
  
  # Apply target mode and calculated speed
  - action: script.evap_set_evap_target
    data:
      evap_entity: "{{ e }}"
      target_mode: "{{ target_mode }}"
      target_speed: "{{ target_speed }}"
      min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
      max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
