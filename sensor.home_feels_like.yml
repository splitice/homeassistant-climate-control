template:
  - sensor:
      - name: "Home Feels Like"
        unique_id: home_feels_like
        unit_of_measurement: "째C"
        device_class: temperature
        state_class: measurement
        availability: >-
          {{
            states('sensor.home_temperature') not in ['unknown','unavailable','none']
            and states('sensor.viewbank_humidity') not in ['unknown','unavailable','none']
          }}
        state: >-
          {# -----------------------------
          Inputs
          ----------------------------- #}
          {% set external_diff = states('sensor.home_differential_temperature') | float %}
          {% set T_in = states('sensor.home_temperature') | float(default=nan) + (external_diff * 0.05) %}
          {% set RH_in = states('sensor.viewbank_humidity') | float(default=nan) %}
          {% set B = states('sensor.viewbank_temp') | float(default=nan) %}        {# outdoor dry-bulb #}
          {% set RH_out = states('sensor.viewbank_humidity') | float(default=nan) %}
          {% set mode = states('select.roofevap1_e90248_evap_mode') %}
          {% set fan_raw = states('select.roofevap1_e90248_evap_fan_speed') %}
          {% set fan = fan_raw | int(0) %}
          {# -----------------------------
            Tunables (make these input_numbers later if you like)
            ----------------------------- #}
          {% set eta1 = 0.75 %}                 {# effective saturation efficiency @ fan 1 (more pessimistic than #}
          {% set eta10 = 0.5 %}                {# effective saturation efficiency @ fan 10 #}
                
          {# Supply heat gain estimate from outdoor DB temp B (째C) #}
          {% set gain_min = 0 %}       {# 째C at/below T_low #}
          {% set gain_max = 2.0 %}     {# 째C at/above T_high #}
          {% set T_low = 23.0 %}       {# below this, clamp to gain_min #}
          {% set T_high = 40.0 %}      {# above this, clamp to gain_max #}
          {# Anchor: 35C -> 1.5C #}
          {% set T_anchor = 35.0 %}
          {% set gain_anchor = 1.5 %}
          {# Compute slope so that at T_anchor we hit gain_anchor, while still clamping at ends #}
          {% set slope = (gain_anchor - gain_min) / (T_anchor - T_low) %}
          {% if B is not number %}
            {% set supply_heat_gain = gain_anchor %}
          {% else %}
            {% set raw = gain_min + slope * (B - T_low) %}
            {% set supply_heat_gain = [gain_min, [raw, gain_max] | min] | max %}
          {% endif %}
          {% set mix_max = 0.55 %}              {# 0..1: how much supply temp can influence "effective" indoor tem #}
          {% set rh_boost_max = 6.0 %}          {# %RH increase at fan 10 when cooling (optional, small) #}
          {% set v_min = 0.5 %}
          {% set v_max = 4 %}
          {% set e_constant = 2.718281828 %}
          {# -----------------------------
            Handle inactive states
            ----------------------------- #}
          {% set evap_active =
              (mode in ['cool','fan_only'])
              and (fan_raw not in [none, 'off', '0', 0])
              and (fan > 0)
          %}
          {# Base apparent temperature (no fan effect) #}
          {% if T_in is not number or RH_in is not number %}
            {{ T_in }}
          {% else %}
            {% set RH0 = 60.0 %}
            {% set k = 0.1 %}
            
            {% set es0 = 6.105 * (e_constant ** (17.27 * T_in / (237.7 + T_in))) %}
            
            {% set rh0 = RH_in | float %}
            {% set rh_lin0 = (rh0 / 100.0) %}
            {% set rh_extra0 = ((max(0.0, rh0 - RH0) / (100.0 - RH0)) ** 2) %}
            
            {% set e0 = es0 * (rh_lin0 + k * rh_extra0) %}
            
            {% set AT_base = T_in + (0.3 * e0) - 2 %}
            {% if not evap_active %}
              {{ (AT_base - 2) | round(1) }}
            {% else %}
              {# -----------------------------
                Fan normalisation
                ----------------------------- #}
              {% set fan = [1, [fan, 10] | min] | max %}
              {% set fan_frac = (fan - 1) / 11 %}
              {% if fan > 0 %}
                {% set fan_frac = fan_frac + 2/11 %}
              {% endif %}
              {# -----------------------------
                Wet-bulb (Stull) with correct atan placement
                ----------------------------- #}
              {% set Twb =
                (
                  (B * ((0.151977 * (RH_out + 8.313659) ** 0.5) | atan))
                  + ((B + RH_out) | atan)
                  - ((RH_out - 1.676331) | atan)
                  + (0.00391838 * RH_out ** 1.5 * ((0.023101 * RH_out) | atan))
                  - 4.686035
                )
              if (B is number and RH_out is number and RH_out > 0)
              else nan %}
              {# If we can't compute Twb, fall back to old AT with airspeed only #}
              {% if Twb is not number %}
                {% set v = v_min + fan_frac * (v_max - v_min) %}
                {% set RH0 = 60.0 %}
                {% set k = 0.1 %}          {# how hard it ramps after RH0 #}
                
                {% set es = 6.105 * (e_constant ** (17.27 * T_eff / (237.7 + T_eff))) %}
                
                {% set rh = RH_eff | float %}
                {% set rh_lin = (rh / 100.0) %}
                {% set rh_extra = ((max(0.0, rh - RH0) / (100.0 - RH0)) ** 2) %}   {# quadratic ramp #}
                
                {% set e = es * ( rh_lin + k * rh_extra ) %}
                {% set AT = T_eff + 0.3 * e - 0.80 * v - 4.0 %}
                {{ AT | round(1) }}
              {% else %}
                {# -----------------------------
                  Predict supply temperature from Twb + efficiency
                  Ts = B - eta*(B - Twb) + heat_gain
                  eta interpolated fan1..fan10
                  ----------------------------- #}
                {% set eta = eta1 + (eta10 - eta1) * fan_frac %}
                {% set Ts_pred = (B - eta * (B - Twb)) + supply_heat_gain %}
                {# -----------------------------
                  Mixing model: effective indoor temp shifts toward Ts_pred as fan increases
                  mix_coeff 0..mix_max (fan dependent)
                  ----------------------------- #}
                {% set mix_coeff = mix_max * fan_frac %}
                {% set T_eff = T_in - mix_coeff * (T_in - Ts_pred) %}
                {# Optional: humidity rises a bit in cool mode (keep small)
                  Use indoor RH as baseline; just nudge it a bit for comfort calculation.
                #}
                {% set RH_eff = RH_in %}
                {% if mode == 'cool' %}
                  {% set RH_eff = [0, [RH_in + (rh_boost_max * fan_frac), 100] | min] | max %}
                {% endif %}
                {# Airspeed term #}
                {% set v = v_min + fan_frac * (v_max - v_min) %}
                {# Steadman apparent temp using T_eff + RH_eff + v #}
                {% set RH0 = 60.0 %}
                {% set k = 0.1 %}          {# how hard it ramps after RH0 #}
                
                {% set es = 6.105 * (e_constant ** (17.27 * T_eff / (237.7 + T_eff))) %}
                
                {% set rh = RH_eff | float %}
                {% set rh_lin = (rh / 100.0) %}
                {% set rh_extra = ((max(0.0, rh - RH0) / (100.0 - RH0)) ** 2) %}   {# quadratic ramp #}
                
                {% set e = es * ( rh_lin + k * rh_extra ) %}
                {% set AT = T_eff + 0.3 * e - 0.80 * v - 4.0 %}
                {{ AT | round(1) }}
              {% endif %}
            {% endif %}
          {% endif %}
        attributes:
          air_temp_c: "{{ states('sensor.home_temperature') | float(0) }}"
          humidity_pct: "{{ states('sensor.viewbank_humidity') | float(0) }}"
          evap_state: "{{ states('select.roofevap1_e90248_evap_mode') }}"
          evap_fan_mode: "{{ states('select.roofevap1_e90248_evap_fan_speed') }}"
