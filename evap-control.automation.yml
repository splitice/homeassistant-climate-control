alias: "Evap Automation (v4)"
description: Main control loop for evaporative cooler with pad drying and maintain/get-to-target modes
triggers:
  - entity_id: input_boolean.automatic_control
    to: "on"
    id: auto_on
    trigger: state
  - entity_id: input_boolean.automatic_control
    to: "off"
    id: auto_off
    trigger: state
  - event: start
    id: ha_start
    trigger: homeassistant
variables:
  evap_entity: select.roofevap1_e90248_evap_mode
  fan_speed_entity: select.roofevap1_e90248_evap_fan_speed
  setpoint_entity: input_number.target_temperature
  auto_entity: input_boolean.automatic_control
  outdoor_temp_entity: sensor.viewbank_temp
  outdoor_humidity_entity: sensor.viewbank_humidity
  indoor_temperature_entity: sensor.home_temperature
  indoor_humidity_entity: sensor.viewbank_humidity
  pad_drying_entity: input_number.pad_drying_progress
  max_fan_speed_entity: null
  min_fan_speed_entity: null
  maintain_threshold_upper: 1.0
  maintain_threshold_lower: -0.5
  pad_dry_time_speed1: 10
  pad_dry_time_speed10: 5
  deadband_cooling_upper: 0.3
  deadband_cooling_lower: 0.0
  pad_drying_necessary: false
  turning_off_start: null
actions:
  # Exit if automatic control is off
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_state(auto_entity, 'off') }}"
        sequence:
          - target:
              entity_id: scene.evap_restore
            action: scene.turn_on
          - stop: Automatic control is off; restored snapshot.

  # Take snapshot of current evap state
  - data:
      scene_id: evap_restore
      snapshot_entities:
        - "{{ evap_entity }}"
        - "{{ fan_speed_entity }}"
    action: scene.create

  # Initialize global variables
  - variables:
      pad_drying_previous: 0
      temp_change_unavailable: -999 # Sentinel value indicating temperature change rate not available
      temperature_change_per_minute: -999
      pad_drying_enabled: false
      alg_state: "initial"

  # Main control loop
  - repeat:
      while:
        - condition: template
          value_template: "{{ is_state(auto_entity, 'on') }}"
      sequence:
        # Calculate current state variables
        - variables:
            setpoint_temp: "{{ states(setpoint_entity) | float(22) }}"
            outdoor_temp: "{{ states(outdoor_temp_entity) | float(30) }}"
            outdoor_rh: "{{ states(outdoor_humidity_entity) | float(50) }}"
            indoor_temp_raw: "{{ states(indoor_temperature_entity) | float(22) }}"
            indoor_rh: "{{ states(indoor_humidity_entity) | float(50) }}"
            cur_mode: "{{ states(evap_entity) }}"
            cur_fan: "{{ states(fan_speed_entity) | int(1) }}"

            # Calculate indoor feels like temperature with current fan speed
            indoor_feels_like_temp: "{{ states('sensor.home_feels_like') }}"

            diff: "{{ indoor_feels_like_temp - setpoint_temp }}"
            at_target: "{{ diff <= deadband_cooling_upper and diff >= deadband_cooling_lower }}"
            should_maintain: "{{ diff <= maintain_threshold_upper and diff >= maintain_threshold_lower }}"
            needs_cooling: "{{ not (diff < maintain_threshold_upper) }}"

        # Reset alg_state
        - variables:
            alg_state: "initial"

        # Handle cooling needs
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ should_maintain or needs_cooling }}"
              sequence:
                - variables:
                    pad_drying_enabled: false
                    turning_off_start: null
                    alg_state: |-
                      {% if should_maintain %}
                        maintain
                      {% else %}
                        get_to_target
                      {% endif %}
                    allowed_cool_mode: |-
                      {% if indoor_rh > 65 %}
                        false
                      {% else %}
                        true
                      {% endif %}

                # Call appropriate script based on mode
                - choose:
                    # Maintain temperature mode
                    - conditions:
                        - condition: template
                          value_template: "{{ should_maintain }}"
                      sequence:
                        - action: script.evap_maintain_temperature_v4
                          continue_on_error: true
                          data:
                            evap_entity: "{{ evap_entity }}"
                            fan_speed_entity: "{{ fan_speed_entity }}"
                            setpoint_entity: "{{ setpoint_entity }}"
                            outdoor_temp_entity: "{{ outdoor_temp_entity }}"
                            outdoor_humidity_entity: "{{ outdoor_humidity_entity }}"
                            indoor_temperature_entity: "{{ indoor_temperature_entity }}"
                            indoor_humidity_entity: "{{ indoor_humidity_entity }}"
                            at_target: "{{ at_target }}"
                            deadband_cooling_upper: "{{ deadband_cooling_upper }}"
                            deadband_cooling_lower: "{{ deadband_cooling_lower }}"
                            min_fan_speed_entity: "{{ min_fan_speed_entity }}"
                            max_fan_speed_entity: "{{ max_fan_speed_entity }}"
                            temperature_change_per_minute: "{{ temperature_change_per_minute }}"
                            allowed_cool: "{{ allowed_cool_mode | bool }}"
                  # Get to target mode
                  default:
                    - action: script.evap_get_to_target_temperature
                      continue_on_error: true
                      data:
                        evap_entity: "{{ evap_entity }}"
                        fan_speed_entity: "{{ fan_speed_entity }}"
                        setpoint_entity: "{{ setpoint_entity }}"
                        outdoor_temp_entity: "{{ outdoor_temp_entity }}"
                        outdoor_humidity_entity: "{{ outdoor_humidity_entity }}"
                        indoor_temperature_entity: "{{ indoor_temperature_entity }}"
                        indoor_humidity_entity: "{{ indoor_humidity_entity }}"
                        min_fan_speed_entity: "{{ min_fan_speed_entity }}"
                        max_fan_speed_entity: "{{ max_fan_speed_entity }}"

            # Start pad drying if transitioning from cool mode
            - conditions:
                - condition: template
                  value_template: "{{ pad_drying_necessary | bool and not pad_drying_enabled }}"
              sequence:
                - variables:
                    alg_state: "pad_drying_start"
                    pad_drying_enabled: true
                    turning_off_start: null

                # Reset pad drying progress
                - action: input_number.set_value
                  data:
                    entity_id: "{{ pad_drying_entity }}"
                    value: 0

                - action: script.evap_pad_drying
                  continue_on_error: true
                  data:
                    evap_entity: "{{ evap_entity }}"
                    fan_speed_entity: "{{ fan_speed_entity }}"
                    pad_drying_entity: "{{ pad_drying_entity }}"
                    pad_dry_time_speed1: "{{ pad_dry_time_speed1 }}"
                    pad_dry_time_speed10: "{{ pad_dry_time_speed10 }}"
                    pad_drying_previous: 0
                    setpoint_entity: "{{ setpoint_entity }}"
                    indoor_temp_entity: "{{ indoor_temperature_entity }}"
                    min_fan_speed_entity: "{{ min_fan_speed_entity }}"
                    max_fan_speed_entity: "{{ max_fan_speed_entity }}"

                - variables:
                    pad_drying_previous: "{{ as_timestamp(now()) | int }}"

            # Continue pad drying if already in progress
            - conditions:
                - condition: template
                  value_template: "{{ pad_drying_enabled == true }}"
              sequence:
                - variables:
                    alg_state: "pad_drying"
                    turning_off_start: null

                - action: script.evap_pad_drying
                  continue_on_error: true
                  data:
                    evap_entity: "{{ evap_entity }}"
                    fan_speed_entity: "{{ fan_speed_entity }}"
                    pad_drying_entity: "{{ pad_drying_entity }}"
                    pad_dry_time_speed1: "{{ pad_dry_time_speed1 }}"
                    pad_dry_time_speed10: "{{ pad_dry_time_speed10 }}"
                    pad_drying_previous: "{{ pad_drying_previous }}"
                    setpoint_entity: "{{ setpoint_entity }}"
                    indoor_temp_entity: "{{ indoor_temperature_entity }}"
                    min_fan_speed_entity: "{{ min_fan_speed_entity }}"
                    max_fan_speed_entity: "{{ max_fan_speed_entity }}"

                - variables:
                    pad_drying_previous: "{{ as_timestamp(now()) | int }}"

            # If current mode is fan, speed is 1, and not needing cooling, get ready to turn off
            - conditions:
                - condition: template
                  value_template: "{{ not pad_drying_necessary | bool and cur_mode == 'fan_only' and cur_fan == 1 and diff < maintain_threshold_lower }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ turning_off_start is none }}"
                      sequence:
                        - variables:
                            alg_state: "turning_off"
                            turning_off_start: "{{ as_timestamp(now()) | int }}"
                    - conditions:
                        - condition: template
                          value_template: "{{ (as_timestamp(now()) - turning_off_start) | int >= 120 }}"
                      sequence:
                        - variables:
                            alg_state: "turning_off"

                        - action: script.evap_set_evap_target
                          continue_on_error: true
                          data:
                            evap_entity: "{{ evap_entity }}"
                            fan_speed_entity: "{{ fan_speed_entity }}"
                            target_mode: "off"
                            target_speed: -1
                            min_fan_speed_entity: "{{ min_fan_speed_entity | default(none) }}"
                            max_fan_speed_entity: "{{ max_fan_speed_entity | default(none) }}"
            - conditions:
                - condition: template
                  value_template: "{{ cur_mode == 'fan_only' }}"
              sequence:
                - variables:
                    alg_state: "reduce_fan"
                - action: script.evap_maintain_temperature_v4
                  continue_on_error: true
                  data:
                    evap_entity: "{{ evap_entity }}"
                    fan_speed_entity: "{{ fan_speed_entity }}"
                    setpoint_entity: "{{ setpoint_entity }}"
                    outdoor_temp_entity: "{{ outdoor_temp_entity }}"
                    outdoor_humidity_entity: "{{ outdoor_humidity_entity }}"
                    indoor_temperature_entity: "{{ indoor_temperature_entity }}"
                    indoor_humidity_entity: "{{ indoor_humidity_entity }}"
                    at_target: "{{ at_target }}"
                    deadband_cooling_upper: "{{ deadband_cooling_upper }}"
                    deadband_cooling_lower: "{{ deadband_cooling_lower }}"
                    min_fan_speed_entity: "{{ min_fan_speed_entity }}"
                    max_fan_speed_entity: "{{ max_fan_speed_entity }}"
                    temperature_change_per_minute: "{{ temperature_change_per_minute }}"
                    allowed_cool: false

        # Record state after changes
        - variables:
            new_fan_speed: "{{ states(fan_speed_entity) | int(1) }}"
            new_fan_mode: "{{ states(evap_entity) }}"
            pad_drying_necessary: |-
              {% if (pad_drying_necessary | bool) or (states(evap_entity) == "cool") %}
                true
              {% else %}
                false
              {% endif %}

        # Log changes and wait
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ new_fan_speed != cur_fan or new_fan_mode != cur_mode }}"
              sequence:
                - action: logbook.log
                  data:
                    name: "Evap Control v4"
                    message: >-
                      Evap control alg {{ alg_state }} adjusted mode from {{ cur_mode }} to {{ new_fan_mode }}, 
                      fan speed from {{ cur_fan }} to {{ new_fan_speed }} due to temp diff {{ diff | round(2) }}Â°C

                - variables:
                    start_wait: "{{ now() }}"

                - wait_for_trigger:
                    - entity_id: input_number.target_temperature
                      id: setpoint_changed
                      trigger: state
                    - entity_id: input_boolean.automatic_control
                      to: "off"
                      id: auto_turned_off
                      trigger: state
                  timeout: "00:01:00"
                  continue_on_timeout: true
          default:
            - variables:
                start_wait: "{{ now() }}"

            - wait_for_trigger:
                - entity_id: input_number.target_temperature
                  id: setpoint_changed
                  trigger: state
                - entity_id: input_boolean.automatic_control
                  to: "off"
                  id: auto_turned_off
                  trigger: state
              timeout: "00:00:30"
              continue_on_timeout: true

        # Calculate temperature change rate
        - variables:
            new_temperature_raw: "{{ states(indoor_temperature_entity) | float(22) }}"
            elapsed_time: "{{ (as_timestamp(now()) - as_timestamp(start_wait)) | int }}"
            min_elapsed_for_trend: 5 # Minimum seconds elapsed to calculate reliable trend
            temp_change_unavailable: -999 # Sentinel value indicating temperature change rate not available
            temperature_change_per_minute: |-
              {% set min_time = 5 %}
              {% set unavailable = -999 %}
              {% if elapsed_time > min_time %}
                {{ (new_temperature_raw - indoor_temp_raw) / (elapsed_time / 60) }}
              {% else %}
                {{ unavailable }}
              {% endif %}

mode: restart
