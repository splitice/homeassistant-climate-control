alias: evap_ramp_fan_in_fan_only
mode: restart
fields:
  evap_entity:
    description: Climate entity
    example: climate.evap
  fan_only_since:
    description: Timestamp when fan_only mode started
    example: "2024-01-01 12:00:00"
  fan_only_start_speed:
    description: Initial fan speed when entering fan_only mode
    example: 5
  ramp_duration_minutes:
    description: Optional. Duration in minutes to complete the ramp down. Defaults to 5 minutes.
    example: 5
  outdoor_temp_entity:
    description: Optional. Outdoor temperature sensor for aggressive mode detection
    example: sensor.viewbank_temp
  setpoint_entity:
    description: Optional. Target temperature for aggressive mode detection
    example: input_number.target_temperature
  aggressive_temp_threshold:
    description: Optional. Temperature difference in °C to trigger aggressive mode. Defaults to 2.0°C.
    example: 2.0
sequence:
  - variables:
      e: "{{ evap_entity }}"
      start_time: "{{ fan_only_since }}"
      raw_start_speed: "{{ fan_only_start_speed | int(1) }}"
      current_fan: "{{ state_attr(evap_entity, 'fan_mode') | int(1) }}"
      max_retries: 20
      aggressive_threshold: "{{ aggressive_temp_threshold | float(2.0) if aggressive_temp_threshold is defined else 2.0 }}"
      default_duration_mins: 5
      aggressive_duration_mins: 2
      # Get temperature values, using sentinel value to detect invalid states
      outdoor_temp: "{{ states(outdoor_temp_entity) | float(none) if outdoor_temp_entity is defined else none }}"
      setpoint: "{{ states(setpoint_entity) | float(none) if setpoint_entity is defined else none }}"
      # Aggressive mode: outdoor temp > (setpoint + threshold)
      is_aggressive: >-
        {{ (outdoor_temp is not none and setpoint is not none and 
           (outdoor_temp - setpoint) > aggressive_threshold) }}
      # Cap start speed at 6 if it's higher
      start_speed: "{{ [6, raw_start_speed] | min }}"
      # Determine duration: aggressive if conditions met, otherwise use provided or default
      duration_minutes: >-
        {% if is_aggressive %}
          {{ aggressive_duration_mins }}
        {% elif ramp_duration_minutes is defined %}
          {{ ramp_duration_minutes | int(default_duration_mins) }}
        {% else %}
          {{ default_duration_mins }}
        {% endif %}
      total_duration_secs: "{{ duration_minutes * 60 }}"
      elapsed_secs: |-
        {% if start_time is none %}
          0
        {% else %}
          {{ [0, (as_timestamp(now()) - as_timestamp(start_time)) | int(0)] | max }}
        {% endif %}
      target_fan: |-
        {% if start_speed <= 1 %}
          1
        {% elif elapsed_secs >= total_duration_secs %}
          1
        {% else %}
          {% set progress = elapsed_secs / total_duration_secs %}
          {% set speed_range = start_speed - 1 %}
          {% set calculated = start_speed - (speed_range * progress) %}
          {% set floored = calculated | int %}
          {% set clamped = [1, floored] | max %}
          {{ clamped }}
        {% endif %}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ target_fan != current_fan }}"
        sequence:
          - repeat:
              until:
                - condition: template
                  value_template: >-
                    {{ state_attr(e,'fan_mode') == (target_fan | string) or
                    repeat.index >= max_retries }}
              sequence:
                - action: climate.set_fan_mode
                  data:
                    entity_id: "{{ e }}"
                    fan_mode: "{{ target_fan }}"
                - delay: "00:00:01"
description: >-
  Gradually ramp down fan speed from start_speed to 1 over a configurable duration (default 5 minutes) in fan_only mode.
  Supports aggressive mode (2 minutes) when outdoor temperature exceeds setpoint by configurable threshold (default 2°C).
  Caps start speed at 6 if higher.
